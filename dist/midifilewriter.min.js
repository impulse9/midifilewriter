/* MIDIFileWriter 0.9.0
 * (c) 2017 Danijel Durakovic MIT license */
var MIDIfw=function(){"use strict";function t(t,n){for(var e=new Array(n),r=n-1;r>=0;r--)e[r]=255&t,t>>=8;return e}function n(t){var n=[],e=!0;do{var r=127&t;t>>=7,e?(n.unshift(r),e=!1):n.unshift(128|r)}while(t>0);return n}function e(t){for(var n=t.byteLength,e="",r=0;n>r;r++)e+=String.fromCharCode(t[r]);return btoa(e)}function r(n){function e(t){if("string"==typeof t){var n,e=5,r=!1;if(t.length>1){var i=t[t.length-1];isNaN(i)||(e=parseInt(i),r=!0)}return n=r?t.slice(0,t.length-1):t,P.indexOf(n.toLowerCase())%12+12*e}return t}function r(t){if("string"==typeof t){var n,e=1,r=!1,i=t[t.length-1];return isNaN(i)||(e=parseInt(i),(1>e||e>8)&&(e=1),r=!0),n=r?t.slice(0,t.length-1):t,8*T.indexOf(n.toLowerCase())+e}return t}var i=n&&n.channel&&n.channel>=0&&n.channel<=S?n.channel:B,a=[];this.setInstrument=function(t){if(void 0!==t&&void 0!==t.instrument){var n=t.time||0,e=r(t.instrument),o=new L.programChange(n,i,e);a.push(o)}return this},this.noteOn=function(t){if(void 0!==t&&void 0!==t.time&&void 0!==t.note){var n=t.time,r=0,o=e(t.note),c=t.velocity||w;if(o>=0&&x>=o&&c>=0&&A>=c){var s=new L.note(n,i,r,o,c);a.push(s)}}return this},this.noteOff=function(t){if(void 0!==t&&void 0!==t.time&&void 0!==t.note){var n=t.time,r=e(t.note),o=1,c=0;if(r>=0&&x>=r){var s=new L.note(n,i,o,r,c);a.push(s)}}return this},this.getBytes=function(n){var e,r=u,i=[];if(n instanceof Array){var o=n.length;for(e=0;o>e;e++)i=i.concat(n[e].getBytes())}var c=a.length;for(e=0;c>e;e++)i=i.concat(a[e].getBytes());var s=new L.meta(d);return i=i.concat(s.getBytes()),r=r.concat(t(i.length,4)),r=r.concat(i)}}function i(n){function i(){var n=d.length,e=n>1?n+1:n,r=a;return r=r.concat(o),r=r.concat(n>1?s:c),r=r.concat(t(e,2)),r=r.concat(t(h,2))}function u(){var n=v[0],e=v[1];(0===e||e&e-1)&&(e=I);var r=t(n,1);r=r.concat(t(Math.log2(e),1)),r.push(y,p);var i=new L.meta(l,r),a=t(Math.floor(6e7/g),3),o=new L.meta(m,a);return[i,o]}function f(){var t=d.length,n=i(),e=u();if(t>1){var a=new r;n=n.concat(a.getBytes(e))}for(var o=0;t>o;o++){var c=d[o],s=1===t&&0===o?c.getBytes(e):c.getBytes();n=n.concat(s)}return n}var h=n&&n.ticksPerBeat&&n.ticksPerBeat>0&&n.ticksPerBeat<=N?n.ticksPerBeat:k,g=n&&n.tempo&&n.tempo>0?n.tempo:b,v=n&&n.timeSignature instanceof Array&&2===n.timeSignature.length?[n.timeSignature[0],n.timeSignature[1]]:[C,I],d=[];this.addTrack=function(){for(var t=0;t<arguments.length;t++){var n=arguments[t];d.push(n)}return this},this.addTracks=this.addTrack,this.getBytes=function(){return new Uint8Array(f())},this.getBase64=function(){return e(this.getBytes())},this.getDataURI=function(){return O+this.getBase64()}}var a=[77,84,104,100],o=[0,0,0,6],c=[0,0],s=[0,1],u=[77,84,114,107],f=144,h=128,g=192,v=255,d=47,l=88,m=81,y=24,p=8,B=0,w=64,k=96,b=60,C=4,I=4,S=15,x=127,A=127,N=65535,O="data:audio/midi;base64,",P=["c","c#","d","d#","e","f","f#","g","g#","a","a#","b"],T=["piano","chrome","organ","guitar","bass","string","ensemble","brass","reed","pipe","synthlead","synthpad","synthfx","ethnic","percussive","sfx"],L={note:function(t,e,r,i,a){this.getBytes=function(){var o=n(t),c=e|(r?h:f);return o.push(c,i,a),o}},programChange:function(t,e,r){this.getBytes=function(){var i=n(t),a=e|g;return i.push(a,r),i}},meta:function(t,e){this.getBytes=function(){e=e||[];var r=0,i=n(r);return i.push(v,t),i=i.concat(n(e.length)),i=i.concat(e)}}};return{createTrack:function(t){return new r(t)},createFile:function(t){return new i(t)}}}();